name: Packages Build

on:
  workflow_dispatch:
    inputs:
      MODEL:
        required: true
        description: 选择需要编译的固件
        type: choice
        default: Lean_x86_64_18.04
        options:
          - Lean_x86_64_18.04
          - Lean_x86_64_24.01
          - Lean_Cudy_18.04
          - Lean_R3S_18.04
          - Immortalwrt_x86_64

  push:
    paths:
      - '**/packages.json'

run-name: 编译 Packages

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id

    steps:
      - name: 检验仓库
        uses: actions/checkout@v4

      - name: 设置 MODEL 环境变量
        id: set_model
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "使用手动触发传入的 MODEL: ${{ github.event.inputs.MODEL }}"
            echo "MODEL=${{ github.event.inputs.MODEL }}" >> $GITHUB_ENV
          else
            # push 触发，从改动的 packages.json 路径中提取 MODEL 目录名
            MODEL_DIR=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep 'packages.json' | head -n1 | cut -d '/' -f2)
            echo "自动提取到 MODEL: $MODEL_DIR"
            echo "MODEL=$MODEL_DIR" >> $GITHUB_ENV
          fi

      - name: 检测脚本
        run: |
          source "${GITHUB_WORKSPACE}/build/${{ env.MODEL }}/settings.ini"
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "FIRMWARE_MESSAGE=${FIRMWARE_MESSAGE}" >> $GITHUB_ENV
          echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV
          echo "UPLOAD_IPK=${UPLOAD_IPK}" >> $GITHUB_ENV
          echo "CACHE_BUILD=true" >> $GITHUB_ENV
          echo "WORKPATH=${GITHUB_WORKSPACE}/openwrt/build/${{ env.MODEL }}" >> $GITHUB_ENV
          echo "PLUGIN_CONFIG_PATH=build/${{ env.MODEL }}/packages.json" >> $GITHUB_ENV

      - name: 整理系统
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo -E apt-get update
          sudo -E apt-get -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev jq

          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo mkdir -p /github-builder
          sudo chown $USER:$GROUPS /github-builder

      - name: 下载源码
        working-directory: /github-builder
        run: |
          df -hT $PWD
          git clone -b $REPO_BRANCH --single-branch $REPO_URL openwrt
          TOOLCHAIN_HASH=$(cd openwrt && git log --pretty=tformat:'%h' -n1 tools toolchain || echo none)
          echo "TOOLCHAIN_HASH=$TOOLCHAIN_HASH" >> $GITHUB_ENV
          echo "$TOOLCHAIN_HASH" > openwrt/.toolchain.hash
          ln -sf /github-builder/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 缓存加速
        uses: xcz-ns/cachewrtbuild@main
        if: env.CACHE_BUILD == 'true'
        with:
          ccache: "true"
          prefix: ${{ github.workspace }}/openwrt
          mixkey: ${{ env.FIRMWARE_MESSAGE }}

      - name: 更新时区
        id: date
        run: |
          sudo timedatectl set-timezone "$TZ"
          echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV

      - name: 安装源码
        run: |
          cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
          cd openwrt

          ./scripts/feeds clean
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f
          ./scripts/feeds install -a -f

          CONFIG_FILE="${GITHUB_WORKSPACE}/${{ env.PLUGIN_CONFIG_PATH }}"
          echo "读取插件配置文件: $CONFIG_FILE"

          plugin_count=$(jq length "$CONFIG_FILE")
          for i in $(seq 0 $((plugin_count - 1))); do
            GIT=$(jq -r ".[$i].git" "$CONFIG_FILE")
            BRANCH=$(jq -r ".[$i].branch // empty" "$CONFIG_FILE")
            PLUGIN_PATH=$(jq -r ".[$i].path" "$CONFIG_FILE")
            CONFIG=$(jq -r ".[$i].config" "$CONFIG_FILE")
            COMPILE=$(jq -r ".[$i].compile_path" "$CONFIG_FILE")

            echo "克隆地址: $GIT"
            echo "分支版本: ${BRANCH:-默认}"
            echo "克隆路径: $PLUGIN_PATH"
            echo "配置项: $CONFIG"
            echo "编译路径: $COMPILE"

            if [ -n "$BRANCH" ]; then
              git clone -b "$BRANCH" "$GIT" "$PLUGIN_PATH"
            else
              git clone "$GIT" "$PLUGIN_PATH"
            fi

            [ -n "$CONFIG" ] && echo "$CONFIG" >> .config
            [ -n "$COMPILE" ] && echo "$COMPILE" >> .plugin_compile_paths
          done

          make defconfig

      - name: 下载文件
        run: |
          cd openwrt && make download -j4

      - name: 编译插件
        id: compile
        run: |
          cd openwrt
          if [ ! -f .plugin_compile_paths ]; then
            echo "未找到插件编译路径文件，跳过插件编译"
            exit 0
          fi

          while IFS= read -r compile_path || [ -n "$compile_path" ]; do
            if [ -n "$compile_path" ]; then
              echo "开始编译插件路径: $compile_path"
              make "$compile_path" V=s
            fi
          done < .plugin_compile_paths

      - name: 整理插件
        id: organizer
        run: |
          mkdir -p ./artifact/package
          rm -rf $(find openwrt/bin/targets/ -type d -name "packages")
          cp -rf $(find openwrt/bin/packages/ -type f -name "*.ipk") ./artifact/package/ || true

      - name: 上传插件
        if: steps.compile.outcome == 'success' && env.UPLOAD_IPK == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.target}}_OpenWrt_package_${{ env.FILE_TIME }}
          path: ./artifact/package/
